{% extends "tracker/base.html" %}

{% block title %}Tablero{% endblock %}

{% block content %}
<div class="dashboard-page">
  <section class="dashboard-hero">
    <div class="dashboard-header">
      <div>
        <p class="eyebrow">Visi贸n general 路 {{ period.label }}</p>
        <h1>Tablero financiero</h1>
        <p class="muted">
          {{ period.start|date:"M d, Y" }} &mdash; {{ period.end|date:"M d, Y" }}
        </p>
      </div>
      <div class="dashboard-controls">
        <div class="range-chips">
          {% for option in period.available_ranges %}
            <a class="chip {% if option.active %}chip-active{% endif %}" href="{{ option.url }}">{{ option.label }}</a>
          {% endfor %}
        </div>
        <form class="expense-filter-form" method="get">
          <label for="dashboard-expense-filter">Cuenta</label>
          <select id="dashboard-expense-filter" name="expense_account" onchange="this.form.submit()">
            <option value="">{% if expense_filter.is_active %}Todas{% else %}Todas las cuentas{% endif %}</option>
            {% for option in expense_filter.options %}
              <option value="{{ option.value }}" {% if option.value == expense_filter.value %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
          {% for key, value in request.GET.items %}
            {% if key != "expense_account" %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
          {% endfor %}
        </form>
      </div>
    </div>

    {% if alerts %}
      <div class="alert-badges">
        {% for alert in alerts %}
          <span class="alert-badge alert-{{ alert.severity }}">{{ alert.label }}: <strong>{{ alert.value }}</strong></span>
        {% endfor %}
      </div>
    {% endif %}

    <div class="kpi-grid">
      <div class="kpi-card">
        <p class="kpi-label">Gasto del periodo</p>
        <p class="kpi-value">
          {{ hero.total_spend|format_number }} {{ hero.currency_totals.0.currency_code|default:"CRC" }}
        </p>
        {% if hero.pct_change %}
          <span class="kpi-delta {% if hero.pct_change > 0 %}delta-up{% else %}delta-down{% endif %}">
            {% if hero.pct_change > 0 %}+{% endif %}{{ hero.pct_change|format_number:1 }}% vs periodo anterior
          </span>
        {% else %}
          <span class="kpi-muted">Sin hist贸rico previo</span>
        {% endif %}
        <ul class="currency-breakdown">
          {% for row in hero.currency_totals %}
            <li>{{ row.currency_code }} 路 {{ row.total|format_number }}</li>
          {% empty %}
            <li>No hay montos registrados</li>
          {% endfor %}
        </ul>
      </div>
      <div class="kpi-card">
        <p class="kpi-label">Promedio diario</p>
        <p class="kpi-value">{{ hero.avg_daily|format_number }} {{ hero.currency_totals.0.currency_code|default:"CRC" }}</p>
        <span class="kpi-muted">Basado en {{ period.days }} d铆as</span>
      </div>
      <div class="kpi-card">
        <p class="kpi-label">Transacciones</p>
        <p class="kpi-value">{{ hero.transaction_count|format_number:0 }}</p>
        <span class="kpi-muted">Ticket promedio: {{ hero.avg_ticket|format_number }} {{ hero.currency_totals.0.currency_code|default:"CRC" }}</span>
      </div>
      <div class="kpi-card">
        <p class="kpi-label">Tarjetas activas</p>
        <p class="kpi-value">{{ hero.active_cards|format_number:0 }}</p>
        <span class="kpi-muted">Tarjetas con gasto en el periodo</span>
      </div>
    </div>
</section>

<section class="section-card category-section">
  <div class="section-header">
    <h2>Insight por categor铆a</h2>
    <p class="muted">Participaci贸n y variaci贸n vs periodo previo</p>
  </div>
  {% if expense_filter.is_active %}
    <div class="info-callout">
      <strong>{{ expense_filter.label }}</strong>
      <span>Presupuesto global, gasto filtrado por esta cuenta; puede haber montos adicionales en otras cuentas.</span>
    </div>
  {% endif %}
  <div class="category-section-body">
    <div class="category-table">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Categor铆a</th>
              <th>Gasto</th>
              <th>Presupuesto</th>
              <th>Disponible</th>
              <th>Uso presupuesto</th>
              <th>Participaci贸n</th>
              <th> periodo anterior</th>
            </tr>
          </thead>
          <tbody>
            {% for item in category_insights %}
              <tr>
                <td>{{ item.label }}</td>
                <td>{{ item.total|format_number }}</td>
                <td>
                  {% if item.budget_limit %}
                    {{ item.budget_limit|format_number }}
                  {% else %}
                    <span class="muted">n/a</span>
                  {% endif %}
                </td>
                <td>
                  {% if item.budget_remaining is not None %}
                    <div class="budget-progress">
                      <div class="budget-progress-track">
                        <span
                          class="budget-progress-fill {% if item.is_budget_over %}over{% endif %}"
                          style="width: {{ item.budget_fill_pct }}%"
                        ></span>
                      </div>
                      <div class="budget-progress-meta">
                        <strong class="{% if item.is_budget_over %}delta-up{% endif %}">
                          {{ item.budget_remaining_abs|format_number }}
                        </strong>
                        <small>
                          {% if item.is_budget_over %}
                            sobrepasado
                          {% else %}
                            por gastar
                          {% endif %}
                        </small>
                      </div>
                    </div>
                  {% else %}
                    <span class="muted">n/a</span>
                  {% endif %}
                </td>
                <td>
                  {% if item.budget_limit %}
                    <span class="{% if item.budget_used_pct and item.budget_used_pct > 100 %}delta-up{% endif %}">
                      {{ item.budget_used_pct|default_if_none:0|format_number:1 }}%
                    </span>
                  {% else %}
                    <span class="muted">n/a</span>
                  {% endif %}
                </td>
                <td>{{ item.share|format_number:1 }}%</td>
                <td>
                  {% if item.delta_pct %}
                    <span class="{% if item.delta_pct > 0 %}delta-up{% else %}delta-down{% endif %}">
                      {% if item.delta_pct > 0 %}+{% endif %}{{ item.delta_pct|format_number:1 }}%
                    </span>
                  {% else %}
                    <span class="kpi-muted">n/a</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="muted">A煤n no hay categor铆as para este rango.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <aside class="category-budget-chart">
      <div class="chart-card">
        <h3>Uso de presupuesto</h3>
        <p class="muted">Top categor铆as con l铆mite asignado</p>
        <ul class="budget-chart-list">
          {% for row in category_budget_chart %}
            <li>
              <div class="budget-chart-head">
                <span>{{ row.label }}</span>
                <small>{{ row.spent|format_number }} / {{ row.budget|format_number }}</small>
              </div>
              <div class="budget-chart-track">
                <span class="budget-chart-fill {% if row.is_over %}over{% endif %}" style="width: {{ row.fill_pct }}%"></span>
              </div>
              <span class="budget-chart-meta {% if row.is_over %}delta-up{% endif %}">{{ row.used_pct|format_number:1 }}% consumido</span>
            </li>
          {% empty %}
            <li class="muted">Agrega presupuestos a tus categor铆as para ver este gr谩fico.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>
  </div>
</section>

<section class="section-card budget-control">
  <div class="section-header">
    <div>
      <h2>Control de presupuesto</h2>
      <p class="muted">Proyecci贸n del periodo seleccionado</p>
    </div>
  </div>
  {% if spend_control.has_budget %}
    <div class="budget-control-layout">
      <div class="budget-control-summary">
        <p class="muted">Avance del presupuesto</p>
        <div class="budget-progress">
          <div class="budget-progress-track">
            <span
              class="budget-progress-fill {% if spend_control.status == 'risk' %}over{% endif %}"
              style="width: {{ spend_control.burn_pct }}%"
            ></span>
          </div>
          <div class="budget-control-meta">
            <div>
              <p class="eyebrow">Gastado</p>
              <strong>{{ spend_control.spent|format_number }}</strong>
            </div>
            <div class="text-right">
              <p class="eyebrow">Presupuesto</p>
              <strong>{{ spend_control.total_budget|format_number }}</strong>
            </div>
          </div>
        </div>
        <div class="budget-status {% if spend_control.status == 'risk' %}status-risk{% else %}status-ok{% endif %}">
          <div>
            {% if spend_control.status == 'risk' %}
              <strong>En riesgo</strong>
              <p>Proyecci贸n excede {{ spend_control.status_delta_abs|format_number }}</p>
            {% else %}
              <strong>En rango</strong>
              <p>Proyecci贸n conserva {{ spend_control.status_delta_abs|format_number }}</p>
            {% endif %}
          </div>
          <span>{{ spend_control.projected_total|format_number }}</span>
        </div>
      </div>
      <div class="budget-control-stat-grid">
        <div class="stat-card">
          <p class="muted">Saldo disponible</p>
          <p class="stat-value {% if spend_control.remaining_budget < 0 %}delta-up{% endif %}">
            {{ spend_control.remaining_budget|format_number }}
          </p>
          <small>vs presupuesto total</small>
        </div>
        <div class="stat-card">
          <p class="muted">Ritmo diario actual</p>
          <p class="stat-value">{{ spend_control.run_rate|format_number }}</p>
          <small>Promedio 煤ltimos {{ spend_control.elapsed_days }} d铆as</small>
        </div>
        <div class="stat-card">
          <p class="muted">Ritmo ideal</p>
          <p class="stat-value">{{ spend_control.ideal_rate|format_number }}</p>
          <small>{{ spend_control.days_total }} d铆as para {{ spend_control.total_budget|format_number }}</small>
        </div>
        <div class="stat-card">
          <p class="muted">D铆as restantes</p>
          <p class="stat-value">{{ spend_control.days_remaining }}</p>
          <small>Periodo seleccionado</small>
        </div>
        <div class="stat-card">
          <p class="muted">Recomendaci贸n diaria</p>
          {% if spend_control.daily_allowance %}
            <p class="stat-value">{{ spend_control.daily_allowance|format_number }}</p>
            <small>Para mantenerte dentro del presupuesto</small>
          {% else %}
            <p class="stat-value muted">--</p>
            <small>Sin d铆as disponibles o sin saldo</small>
          {% endif %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="empty-state">
      <p>Define l铆mites de presupuesto en tus categor铆as para desbloquear este control.</p>
      <a class="mini-link" href="{% url 'tracker:categories' %}">Gestionar categor铆as</a>
    </div>
  {% endif %}
</section>

<section class="section-card">
  <div class="section-header">
    <div>
      <h2>Gasto mensual</h2>
      <p class="muted">Suma por mes (煤ltimos {{ monthly_chart.labels|length }} meses)</p>
    </div>
  </div>
  {% if monthly_chart.has_data %}
    <div class="chart-insights">
      <div>
        <p class="muted">ltimo mes 路 {{ monthly_chart.insights.last_label }}</p>
        <p class="insight-value">{{ monthly_chart.insights.last_value|format_number }}</p>
      </div>
      <div>
        <p class="muted">Vs mes anterior</p>
        {% if monthly_chart.insights.mom_change %}
          <p class="insight-value {% if monthly_chart.insights.mom_change > 0 %}delta-up{% else %}delta-down{% endif %}">
            {% if monthly_chart.insights.mom_change > 0 %}+{% endif %}{{ monthly_chart.insights.mom_change|format_number:1 }}%
          </p>
        {% else %}
          <p class="insight-value muted">n/a</p>
        {% endif %}
      </div>
      <div>
        <p class="muted">Promedio periodo</p>
        <p class="insight-value">{{ monthly_chart.insights.avg_value|format_number }}</p>
      </div>
      <div>
        <p class="muted">Mes pico</p>
        <p class="insight-value">
          {{ monthly_chart.insights.best_label }} 路 {{ monthly_chart.insights.best_value|format_number }}
        </p>
      </div>
    </div>
    <div class="line-chart">
      <svg viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
        {% for y in monthly_chart.grid_lines %}
          <line class="chart-grid" x1="0" y1="{{ y }}" x2="100" y2="{{ y }}" />
        {% endfor %}
        {% if monthly_chart.area_points %}
          <polygon class="chart-area" points="{{ monthly_chart.area_points }}" />
        {% endif %}
        <polyline points="{{ monthly_chart.points }}" />
        {% for point in monthly_chart.markers %}
          <circle cx="{{ point.x }}" cy="{{ point.y }}" r="1.5" />
        {% endfor %}
      </svg>
    </div>
    <div class="chart-labels">
      {% for point in monthly_chart.markers %}
        <span>
          <strong>{{ point.label }}</strong>
          <small>{{ point.value|format_number }}</small>
        </span>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">A煤n no hay datos suficientes para graficar.</p>
  {% endif %}
</section>

<section class="section-card">
  <div class="section-header">
    <div>
      <h2>Cuentas contables</h2>
      <p class="muted">Gasto por cuenta asociada a tarjetas en el periodo</p>
    </div>
  </div>
  {% if expense_accounts.has_data %}
    <div class="expense-account-grid">
      <div class="expense-bars">
        {% for row in expense_accounts.rows %}
          <div class="expense-bar-row">
            <div class="expense-bar-head">
              <div>
                <strong>{{ row.label }}</strong>
                <p class="muted">
                  {{ row.card_count|format_number:0 }} tarjetas 路 {{ row.count|format_number:0 }} transacciones
                </p>
              </div>
              <div class="expense-bar-value">
                <span>{{ row.total|format_number }}</span>
                {% if row.delta_pct %}
                  <small class="{% if row.delta_pct > 0 %}delta-up{% else %}delta-down{% endif %}">
                    {% if row.delta_pct > 0 %}+{% endif %}{{ row.delta_pct|format_number:1 }}% vs periodo anterior
                  </small>
                {% else %}
                  <small class="muted">Sin hist贸rico</small>
                {% endif %}
              </div>
            </div>
            <div class="expense-bar-track">
              <div class="expense-bar-fill" style="width: {{ row.bar_pct }}%">
                {% for segment in row.segments %}
                  <span
                    class="expense-bar-segment"
                    style="width: {{ segment.width_pct }}%; background: {{ segment.color }};"
                  ></span>
                {% endfor %}
              </div>
            </div>
            <div class="expense-bar-meta">
              <span class="muted">{{ row.share_pct|format_number:1 }}% del total</span>
              <div class="expense-tags">
                {% for segment in row.segments %}
                  <span class="expense-tag">
                    {{ segment.label|default:"Sin etiqueta" }}
                    {% if segment.last4 %}
                      路 ⑩⑩⑩{{ segment.last4 }}
                    {% endif %}
                    <small>{{ segment.amount|format_number }}</small>
                  </span>
                {% empty %}
                  <span class="muted">Sin detalle de tarjetas.</span>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="expense-pie-panel">
        <div class="expense-pie" style="{{ expense_accounts.pie_style }}"></div>
        <div class="expense-pie-meta">
          <p class="muted">Total periodo</p>
          <p class="insight-value">{{ expense_accounts.grand_total|format_number }}</p>
          <p class="muted">
            {{ expense_accounts.visible_accounts }}/{{ expense_accounts.total_accounts }} cuentas con movimiento
          </p>
        </div>
        <ul class="expense-legend">
          {% for row in expense_accounts.rows %}
            <li>
              <span class="legend-swatch" style="background: {{ row.color }};"></span>
              <div>
                <strong>{{ row.label }}</strong>
                <small>{{ row.share_pct|format_number:1 }}%</small>
              </div>
              <span>{{ row.total|format_number }}</span>
            </li>
          {% endfor %}
          {% if expense_accounts.others_total %}
            <li>
              <span class="legend-swatch" style="background: #d4d4d8;"></span>
              <div>
                <strong>Otros</strong>
                <small>resto</small>
              </div>
              <span>{{ expense_accounts.others_total|format_number }}</span>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  {% else %}
    <p class="muted">A煤n no hay transacciones con cuentas asignadas a tarjetas.</p>
  {% endif %}
</section>

<section class="section-card">
  <div class="section-header">
    <h2>Se帽ales de comercio</h2>
    <p class="muted">Top comercios y posibles suscripciones</p>
  </div>
  <div class="stacked-block">
      <div>
        <h3>Top comercios</h3>
        <ul class="simple-list">
          {% for merchant in merchant_signals.top_merchants %}
            <li>
              <div>
                <strong>{{ merchant.merchant_name }}</strong>
                <p class="muted">{{ merchant.count|format_number:0 }} transacciones</p>
              </div>
              <span>{{ merchant.total|format_number }}</span>
            </li>
          {% empty %}
            <li class="muted">Sin comercios destacados.</li>
          {% endfor %}
        </ul>
      </div>
      <div>
        <h3>Nuevos comercios</h3>
        <p class="headline">{{ merchant_signals.new_merchants|format_number:0 }}</p>
      </div>
      <div>
        <h3>Posibles suscripciones</h3>
        <ul class="simple-list">
          {% for sub in merchant_signals.suspected_subscriptions %}
            <li>
              <div>
                <strong>{{ sub.merchant_name }}</strong>
                <p class="muted">{{ sub.count|format_number:0 }} cargos ~ {{ sub.amount|format_number }}</p>
              </div>
            </li>
          {% empty %}
            <li class="muted">Sin patrones repetidos significativos.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</section>

<section class="section-grid">
  <div class="section-card">
    <div class="section-header">
      <h2>Salud de tarjetas</h2>
      <p class="muted">Uso por tarjeta y tarjetas inactivas</p>
    </div>
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Tarjeta</th>
            <th>Transacciones</th>
            <th>Total</th>
            <th>Ticket promedio</th>
          </tr>
        </thead>
        <tbody>
          {% for card in card_health.card_stats %}
            <tr>
              <td>{{ card.card__label }} 路 ⑩⑩⑩{{ card.card__last4 }}</td>
              <td>{{ card.count|format_number:0 }}</td>
              <td>{{ card.total|format_number }}</td>
              <td>{{ card.avg|format_number }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="muted">No hay tarjetas con movimiento en este periodo.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="idle-cards">
      <h3>Tarjetas sin uso reciente</h3>
      <ul>
        {% for card in card_health.idle_cards %}
          <li>{{ card.label }} 路 ⑩⑩⑩{{ card.last4 }} {% if card.last_tx %}<span class="muted">(煤ltimo uso {{ card.last_tx|date:"d M" }})</span>{% endif %}</li>
        {% empty %}
          <li class="muted">Todas las tarjetas tuvieron uso reciente.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="section-card">
    <div class="section-header">
      <h2>Pendientes y anomal铆as</h2>
      <p class="muted">Transacciones que requieren atenci贸n</p>
      <div class="section-actions">
        <a class="btn btn-secondary btn-ghost" href="{% url 'tracker:review_queue' %}">Ver todo</a>
      </div>
    </div>
    <ul class="simple-list attention-list">
      {% for tx in action_queue %}
        <li>
          <div>
            <strong>{{ tx.merchant_name|default:"Sin comercio" }}</strong>
            <p class="muted">
              {{ tx.transaction_date|date:"d M H:i" }} 路 {{ tx.category|default:"Sin categor铆a" }} 路 {{ tx.card|default:"Sin tarjeta" }}
            </p>
          </div>
          <div class="attention-amount">
            <span>{{ tx.amount|format_number }} {{ tx.currency_code }}</span>
            <a class="mini-link" href="{% url 'tracker:transaction_detail' tx.pk %}">Ver</a>
          </div>
        </li>
      {% empty %}
        <li class="muted">Todo se ve bien por ahora </li>
      {% endfor %}
    </ul>
  </div>
</section>

<section class="section-card">
  <div class="section-header">
    <div>
      <h2>Convertir en regla</h2>
      <p class="muted">Comercios con m煤ltiples transacciones sin categor铆a en este periodo.</p>
    </div>
  </div>
  {% if uncategorized_merchants %}
    <ul class="simple-list">
      {% for merchant in uncategorized_merchants %}
        <li>
          <div>
            <strong>{{ merchant.merchant_name }}</strong>
            <p class="muted">
              {{ merchant.count|format_number:0 }} transacciones sin categor铆a
              {% if merchant.card_last4 %}路 **** {{ merchant.card_last4 }}{% endif %}
              {% if merchant.last_tx %}路 煤ltima el {{ merchant.last_tx|date:"d M" }}{% endif %}
            </p>
          </div>
          <div class="attention-amount">
            <span>
              {{ merchant.total|format_number }}
              {% if merchant.currency_code %}{{ merchant.currency_code }}{% endif %}
            </span>
            <a class="btn btn-primary btn-small" href="{{ merchant.rule_url }}">Crear regla</a>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Por ahora no hay comercios repetidos sin categor铆a </p>
  {% endif %}
</section>

<section class="section-grid">
  <div class="section-card">
    <div class="section-header">
      <h2>Automatizaci贸n</h2>
      <p class="muted">Fuentes de categorizaci贸n</p>
    </div>
    <ul class="simple-list">
      {% for row in automation_insight %}
        <li>
          <span>{{ row.category_source|default:"Desconocido" }}</span>
          <strong>{{ row.count }}</strong>
        </li>
      {% empty %}
        <li class="muted">A煤n no hay registros.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="section-card">
    <div class="section-header">
      <h2>Uso de LLM</h2>
      <p class="muted">Costos y decisiones</p>
    </div>
    <div class="llm-summary">
      <p><strong>Costo</strong> {{ llm_usage.summary.total_cost|default_if_none:0|format_number }}</p>
      <p><strong>Tokens prompt</strong> {{ llm_usage.summary.tokens_prompt|default_if_none:0|format_number:0 }}</p>
      <p><strong>Tokens completion</strong> {{ llm_usage.summary.tokens_completion|default_if_none:0|format_number:0 }}</p>
    </div>
    <ul class="simple-list">
      {% for row in llm_usage.decision_breakdown %}
        <li>
          <span>{{ row.decision_type }}</span>
          <strong>{{ row.count }}</strong>
        </li>
      {% empty %}
        <li class="muted">Sin invocaciones en el periodo.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="section-card">
    <div class="section-header">
      <h2>Sincronizaci贸n & data freshness</h2>
      <p class="muted">Estado de los jobs de Gmail</p>
    </div>
    <p class="muted">Correos pendientes por procesar: <strong>{{ sync_health.pending_emails|format_number:0 }}</strong></p>
    {% if sync_health.stale_labels %}
      <div class="alert-badge alert-warn">
        Sincronizaci贸n atrasada en {{ sync_health.stale_labels|join:", " }} (>{{ sync_health.stale_minutes }} min).
      </div>
    {% endif %}
    <ul class="simple-list sync-health-list">
      {% for state in sync_health.states %}
        <li class="{% if state.is_stale %}sync-health-row-stale{% endif %}">
          <div class="sync-health-head">
            <strong>{{ state.label }}</strong>
            {% if state.is_stale %}
              <span class="status-pill status-pill-warn">Atrasado</span>
            {% else %}
              <span class="status-pill status-pill-ok">Ok</span>
            {% endif %}
          </div>
          <p class="muted">
            ltimo historyId: {{ state.history_id|default:"n/a" }} 路 Query: {{ state.query|default:"(por defecto)" }}
          </p>
          <div class="sync-health-meta">
            <div class="sync-health-stat">
              <small>ltima sync</small>
              <span>
                {% if state.last_synced_at %}
                  {{ state.last_synced_at|date:"d M H:i" }}
                {% else %}
                  nunca
                {% endif %}
              </span>
            </div>
            <div class="sync-health-stat">
              <small>Mensajes importados</small>
              <span>{{ state.fetched_messages|format_number:0 }}</span>
            </div>
            <div class="sync-health-stat">
              <small>Reintentos</small>
              <span>{{ state.retry_count|format_number:0 }}</span>
            </div>
          </div>
        </li>
      {% empty %}
        <li class="muted">No se ha configurado la sincronizaci贸n.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="section-card">
    <div class="section-header">
      <h2>Correcciones manuales</h2>
      <p class="muted">Revisiones aplicadas durante el periodo</p>
    </div>
    <p class="muted">
      Total en el periodo: <strong>{{ manual_review.count|format_number:0 }}</strong>
    </p>
    {% if manual_review.recent %}
      <ul class="simple-list">
        {% for correction in manual_review.recent %}
          <li>
            <div>
              <strong>{{ correction.new_merchant_name|default:correction.transaction.merchant_name }}</strong>
              <p class="muted">
                {{ correction.created_at|date:"d M H:i" }} 路
                {{ correction.new_category|default:"Sin categor铆a" }} 路
                {{ correction.transaction.amount|format_number }} {{ correction.transaction.currency_code }}
              </p>
            </div>
            <span class="status-pill status-pill-ok">
              {{ correction.changed_fields|join:", " }}
            </span>
          </li>
        {% endfor %}
      </ul>
      <div class="stacked-block">
        <div>
          <h3>Comercios frecuentes</h3>
          <ul class="simple-list">
            {% for merchant in manual_review.top_merchants %}
              <li>
                <span>{{ merchant.new_merchant_name|default:"(sin comercio)" }}</span>
                <strong>{{ merchant.count|format_number:0 }}</strong>
              </li>
            {% empty %}
              <li class="muted">Sin datos de comercios.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% else %}
      <p class="muted">A煤n no hay correcciones en este rango.</p>
    {% endif %}
  </div>
</section>
</div>
{% endblock %}
